/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

package cl.femase.gestionweb.business;

import cl.femase.gestionweb.common.Utilidades;
import cl.femase.gestionweb.vo.DetalleAsistenciaToInsertVO;
import cl.femase.gestionweb.vo.DetalleAsistenciaVO;
import cl.femase.gestionweb.vo.DetalleAusenciaVO;
import cl.femase.gestionweb.vo.DetalleMarcaVO;
import cl.femase.gestionweb.vo.DetalleTurnoVO;
import cl.femase.gestionweb.vo.EmpleadoVO;
import cl.femase.gestionweb.vo.MarcaVO;
import cl.femase.gestionweb.vo.PropertiesVO;
import cl.femase.gestionweb.vo.TurnoVO;
import cl.femase.gestionweb.vo.DiferenciaHorasVO;
import cl.femase.gestionweb.vo.MaintenanceVO;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Iterator;
import java.util.StringTokenizer;

/**
 * Clase encargada de realizar el calculo de asistencia de los 
 * empleados-
 * 
 * Realiza el calculo de asistencia para los empleados pertenecientes
 * al centro de costo especificado. 
 * Se requiere: empresa, depto, cenco_id, startDate, endDate.
 * 
 * El objetivo es calcular la asistencia de la ultima semana.
 * Por ejemplo, si fecha_actual es 19-04-2018
 *   startDate = fecha_actual - 7 dias = 12-04-2018
 *   endDate = fecha_actual
 * 
 * 
 * @author Alexander
 */
public class CalculoAsistenciaBp {

    public PropertiesVO props;
    private String IT_FECHA = "";
    private HashMap<String, MarcaVO> m_marcasProcesadas = new HashMap<>();
    
    /** para guardar los eventos de mantencion de informacion*/
    private final cl.femase.gestionweb.service.DetalleAsistenciaSrv calculoAsistenciaService;
    
    public List<EmpleadoVO> m_listaEmpleados=new ArrayList<>();
            
    public CalculoAsistenciaBp(PropertiesVO props) {
        this.props = props;
        
        calculoAsistenciaService = new cl.femase.gestionweb.service.DetalleAsistenciaSrv(this.props);
    }

    /**
     * Obtiene lista de empleados, con toda la info de cada empleado.
     * Recibe como parametro una lista de ruts
     */
    private List<EmpleadoVO> getListaEmpleadosComplete(String _empresaId,
            String _deptoId, 
            int _cencoId,
            List<String> _listaRuts){
    
        System.out.println("[CalculoAsistenciaBp."
            + "getListaEmpleadosComplete]"
            + "empresa: "+_empresaId
            +", depto: "+_deptoId
            +", cenco: "+_cencoId);
        
        EmpleadosBp empleadosBp = new EmpleadosBp();
        List<EmpleadoVO> listaFinalEmpleados = new ArrayList<>();
        
        Iterator<String> it = _listaRuts.iterator();
        // mientras al iterador queda proximo juego
        while(it.hasNext()){
            String strRut = it.next();
            System.out.println("[CalculoAsistenciaBp."
                + "getListaEmpleadosComplete]"
                + "get info completa de "
                + "empleado rut: "+ strRut);
            
            List<EmpleadoVO> lstempleados = empleadosBp.getEmpleadosShort(_empresaId, 
                _deptoId, 
                _cencoId, 
                -1,  
                strRut, 
                null, 
                null, 
                null, 
                0, 
                0, 
                "empleado.empl_rut");
            
            listaFinalEmpleados.add(lstempleados.get(0));
        }
        
        m_listaEmpleados = listaFinalEmpleados;
                
        return listaFinalEmpleados;
    }
    
    /**
     * Obtiene lista de empleados para el centro de costo especificado
     * 
     * 
     * @param _empresaId
     * @param _deptoId
     * @param _cencoId
     * @return 
     */
    private List<EmpleadoVO> getListaEmpleados(String _empresaId,
            String _deptoId, 
            int _cencoId){
    
        System.out.println("[CalculoAsistenciaBp."
            + "getListaEmpleados]empresa: "+_empresaId
            +", depto: "+_deptoId
            +", cenco: "+_cencoId);
        
        EmpleadosBp empleadosBp = new EmpleadosBp();
        List<EmpleadoVO> listaEmpleados = new ArrayList<>();
        if (_empresaId.compareTo("-1") != 0 
                && _deptoId.compareTo("-1") != 0
                && _cencoId != -1){
                    //todos los empleados del cenco
                    listaEmpleados = empleadosBp.getEmpleadosShort(_empresaId, 
                            _deptoId, 
                            _cencoId, 
                            -1,  
                            null, 
                            null, 
                            null, 
                            null, 
                            0, 
                            0, 
                            "empleado.empl_rut");
        }
        m_listaEmpleados = listaEmpleados;
        return listaEmpleados;
    }
    
    /**
     *  Calcula asistencia para la lista de empleados especificada.
     *  Si no entrega lista de empleados, se deben rescatar todos los empleados
     *  de la empresa-depto-cenco especificados.
     * 
     * @param _empresaId
     * @param _deptoId
     * @param _cencoId
     * @param _listaRutsEmpleados
     * @param _startDate
     * @param _endDate
     * @return 
     * 
     **/
    public MaintenanceVO calculaAsistencia(String _empresaId,
            String _deptoId, 
            int _cencoId,
            List<String> _listaRutsEmpleados,
            String _startDate, 
            String _endDate){
        MaintenanceVO resultado=new MaintenanceVO();
            
        System.out.println("[GestionFemase."
            + "CalculoAsistenciaBp]calculaAsistencia."
            + "Empresa=" + _empresaId    
            + ",depto=" + _deptoId
            + ",cenco=" + _cencoId
            + ",startDate=" + _startDate
            + ",endDate=" + _endDate);
        ArrayList<DetalleAsistenciaToInsertVO> listaAsistencia = 
            new ArrayList<>();
        //listaAsistencia.clear();
        
        TurnosBp turnosBp = new TurnosBp(new PropertiesVO());
        TiempoExtraBp tiempoExtraBp = new TiempoExtraBp(new PropertiesVO());
        DetalleTurnosBp detalleTurnoBp = new DetalleTurnosBp(new PropertiesVO());
        CalendarioFeriadoBp feriadosBp = new CalendarioFeriadoBp(new PropertiesVO());
        DetalleAsistenciaBp calculoBp = new DetalleAsistenciaBp(new PropertiesVO()); 
        
        Calendar mycal = Calendar.getInstance();
        
        List<EmpleadoVO> listaEmpleadosConMarcas = new ArrayList<>();
        List<EmpleadoVO> listaEmpleados          = new ArrayList<>();
        
        if (_listaRutsEmpleados.isEmpty()){
            listaEmpleados=getListaEmpleados(_empresaId, _deptoId, _cencoId);
            
        }else{
            listaEmpleados = 
                getListaEmpleadosComplete(_empresaId, _deptoId, _cencoId, _listaRutsEmpleados);
        }
        System.out.println("[GestionFemase."
            + "CalculoAsistenciaBp]calculaAsistencia."
            + "listaEmpleados.size()=" +listaEmpleados.size());
        
        /*        
        List<EmpleadoVO> listaEmpleados = new ArrayList<>();
        if (_empresaId.compareTo("-1") != 0 
                && _deptoId.compareTo("-1") != 0
                && _cencoId != -1){
                    //todos los empleados del cenco
                    listaEmpleados = empleadosBp.getEmpleadosShort(_empresaId, 
                            _deptoId, 
                            _cencoId, 
                            -1,  
                            null, 
                            null, 
                            null, 
                            null, 
                            0, 
                            0, 
                            "empleado.empl_rut");
        }
        */
        
        //para controlar error al calcular asistencia
        //boolean isError = false;
        //String errorMessage = "";
        if (listaEmpleados.size() > 0){
            System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia "
                + "Anio actual = " + mycal.get(Calendar.YEAR)
                + ". StartDate = " + _startDate
                + ". EndDate = " + _endDate);

            //rescatar detalle de los turnos existentes, la llave de esta lista es el idTurno del empleado
            LinkedHashMap<Integer, LinkedHashMap<Integer,DetalleTurnoVO>> listaDetalleTurnos = 
                new LinkedHashMap<>();
            //Lista de fechas en formato yyyy-MM-dd
            String[] fechasCalculo = Utilidades.getFechas(_startDate, _endDate);

            /**
             * Se obtiene lista de turnos y su respectivo detalle
             */
            List<TurnoVO> listaTurnos = 
                turnosBp.getTurnos(null, 0, 0, "id_turno");
            HashMap<String,Integer> hashTiposHE = tiempoExtraBp.getTiposHrasExtras();
            for (TurnoVO turno : listaTurnos) {
                LinkedHashMap<Integer,DetalleTurnoVO> detalle = 
                    detalleTurnoBp.getHashDetalleTurno(turno.getId());
                listaDetalleTurnos.put(turno.getId(), detalle);
            }
            HashMap<String,String> hashFeriados = feriadosBp.getHashFeriados(mycal.get(Calendar.YEAR));

            System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia"
                + "Invocando procesa Asistencia para "
                + "los empleados size="+listaEmpleados.size());
            LinkedHashMap<String, ArrayList<DetalleAsistenciaVO>> listaCalculosEmpleado = 
                new LinkedHashMap<>();
            int iteracion = 1;
            for (EmpleadoVO empleado : listaEmpleados) {
                ArrayList<DetalleAsistenciaVO> dataFechasRut = new ArrayList<>();
                listaEmpleadosConMarcas.add(empleado);

                /**
                 * Ejecuta el calculo de asistencia segun
                 * marcas para las fechas solicitadas
                 */
                System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia"
                    + "Inicio procesa Asistencia para "
                    + "rut= " + empleado.getRut()
                    + ", nombre= "+empleado.getNombreCompleto());
                try {
                    dataFechasRut = procesaAsistencia(empleado,
                            fechasCalculo,
                            listaDetalleTurnos,
                            hashFeriados,
                            hashTiposHE);
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia"
                        + ".dataFechasRut.size=" + dataFechasRut.size());
                } catch (Exception ex) {
                    resultado.setMsgError("Error al procesar asistencia para "
                        + "rut= " + empleado.getRut()
                        + ", fecha= " + IT_FECHA);
                    System.err.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia."
                        + resultado.getMsgError());
                    System.err.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia. "
                        + "Error is: " + ex.toString());
                    ex.printStackTrace();
                    resultado.setThereError(true);
                }
                System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia. "
                    + "listaCalculosEmpleado.put "
                    + "KEY= " + empleado.getRut()+"|"+iteracion);

                listaCalculosEmpleado.put(empleado.getRut()+"|"+iteracion, dataFechasRut);

                System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia. "
                    + "Fin procesa Asistencia para "
                    + "rut= " + empleado.getRut());
                iteracion++;
            }//fin for lista empleados     

            if (!resultado.isThereError()){
                /**
                 * Guardar en BD el resultado de los calculos
                 * de asistencia 
                 */
                System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia. "
                    + "Inicio guardar calculos en BD");
////                MaintenanceEventVO resultado2=new MaintenanceEventVO();
////                resultado2.setUsername(userConnected.getUsername());
////                resultado2.setDatetime(new Date());
////                resultado2.setUserIP(request.getRemoteAddr());
////                resultado2.setType("CHR");

                //***inicio llenar datos para los insert
                //Guardar en Base de datos los calculos realizados...
                //Iterar listaFinalCalculos
                System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia."
                    + "Lista Calculos empleado.size= " + listaCalculosEmpleado.size() );
                Iterator<ArrayList<DetalleAsistenciaVO>> itFechas 
                    = listaCalculosEmpleado.values().iterator();
                while (itFechas.hasNext())//while 9
                {   
                    ArrayList<DetalleAsistenciaVO> datosFecha = itFechas.next();
                    Iterator<DetalleAsistenciaVO> itDetails = datosFecha.iterator();
                    while (itDetails.hasNext())//while 9
                    {   
                        DetalleAsistenciaVO calculosFecha = itDetails.next();
                        System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia."
                            + "Agregar calculos para el insert de calculos asistencia. "
                            + "Rut= " + calculosFecha.getRutEmpleado()
                            + ", fechaEntrada= " + calculosFecha.getFechaEntradaMarca()
                            + ", hora entrada= " + calculosFecha.getHoraEntrada()
                            + ", fechaSalida= " + calculosFecha.getFechaSalidaMarca()    
                            + ", hora salida= " + calculosFecha.getHoraSalida()
                            + ", minutos reales= " + calculosFecha.getMinutosReales()    
                            );

                        if (calculosFecha.getFechaEntradaMarca()!=null){
                            System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia."
                                + " add To Insert...");

                            DetalleAsistenciaToInsertVO toInsert 
                                = new DetalleAsistenciaToInsertVO(calculosFecha);
                            listaAsistencia.add(toInsert);
                        }
                    }
                }//fin while 9

                if (listaAsistencia.size() > 0){
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia. "
                        + "Num Empleados "
                        + "a actualizar detalle asistencia= "+listaAsistencia.size());
                    //Abrir conexion a BD
                    calculoBp.openDbConnection();
                    calculoBp.deleteList(listaAsistencia);
                    calculoBp.saveList(listaAsistencia);

                    //cerrar conexion a BD
                    calculoBp.closeDbConnection();
                }
                System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia."
                    + "Fin guardar calculos en BD");
            }
        }else{
            System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia."
                + " No hay empleados...");
        }//fin lista empleados > 0

        if (!resultado.isThereError()){
            System.out.println("[GestionFemase.CalculoAsistenciaBp]calculaAsistencia."
                + " Calculo de asistencia Finalizado...");
        }else{
            System.err.println("[GestionFemase.CalculoAsistenciaBp]"
                + "Error en calculaAsistencia: " + resultado.getMsgError());
        }
        
        return resultado;
    }
    
    
    /**
     * Realiza los calculos de horas asistencia.
     * Iterar fechas (segun rango)
     * Por cada fecha (){
     *    fecha_iteracion = fechas.next()
     *    -rescatar marcas para empleado + fecha_iteracion
     *
     *      si hay marcas {
     *           -proceder al calculo de horas trabajadas para ese dia
     *           -rescatar horas extras:
     *               .- Si el dia corresponde a su turno, las hras extras se consideran al 50%
     *               .- Si el dia NO corresponde a su turno, las hras extras se consideran al 100%
     * 
     *      } de lo contrario { //si no hay marcas para la fecha
     *            - rescatar ausencias para empleado + fecha_iteracion (permisos, licencias, vacaciones, permisos autorizados, etc)
     *            - NO APLICAN HORAS EXTRAS, SIN MARCAS NO HAY HRS EXTRAS
     *      }
     *   }
     * 
     */
    //metodo debe retornar lista con las fechas..en cada fecha los datos calculados,,,
    private ArrayList<DetalleAsistenciaVO> procesaAsistencia(EmpleadoVO _empleado, 
            String[] _fechasCalculo,
            LinkedHashMap<Integer, 
            LinkedHashMap<Integer,DetalleTurnoVO>> _listaDetalleTurnos, 
            HashMap<String,String> _hashFeriados, 
            HashMap<String,Integer> _hashTiposHE) throws Exception{
        System.out.println("[GestionFemase.CalculoAsistenciaBp]procesaAsistencia.");
        //LinkedHashMap<String, DetalleAsistenciaVO> listaDetalleCalculoReturn=new LinkedHashMap<>();
        ArrayList<DetalleAsistenciaVO> listaAux=new ArrayList<>();        
        //try{
            Calendar mycal = Calendar.getInstance();
            
            TurnoRotativoDetalleBp detalleTurnoRotaBp = new TurnoRotativoDetalleBp(new PropertiesVO());
            TurnoRotativoBp turnoRotativobp=new TurnoRotativoBp(new PropertiesVO());
            MarcasBp marcasBp = new MarcasBp(new PropertiesVO());
            DetalleAusenciaBp detalleAusenciaBp = new DetalleAusenciaBp(new PropertiesVO());
            SimpleDateFormat fullFechaFmt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
//            SimpleDateFormat soloFechaFmt = new SimpleDateFormat("yyyy-MM-dd");
            LinkedHashMap<String, MarcaVO> marcas = 
                new LinkedHashMap<>();
            
            for( int i = 0; i <= _fechasCalculo.length - 1; i++)
            {
                boolean tieneTurnoRotativo=false;
                boolean continuar=true;
                IT_FECHA = _fechasCalculo[i];
                StringTokenizer tokenfecha1=new StringTokenizer(IT_FECHA, "-");
                String strAnio = tokenfecha1.nextToken();
                String strMes = tokenfecha1.nextToken();
                String strDia = tokenfecha1.nextToken();
                int codDia = 
                    Utilidades.getDiaSemana(Integer.parseInt(strAnio), 
                        Integer.parseInt(strMes), 
                        Integer.parseInt(strDia));
                marcas = new LinkedHashMap<>();
                System.out.println("[GestionFemase.CalculoAsistenciaBp]procesaAsistencia."
                    + "Itera fecha " + IT_FECHA);
                
                /**
                 * Rescata asignacion de turno rotativo
                 */
                DetalleTurnoVO asignacionTurnoRotativo = 
                    turnoRotativobp.getAsignacionTurnoByFecha(_empleado.getEmpresa().getId(), _empleado.getRut(), 
                            IT_FECHA);
//                //Rescata detalle turno rotativo (dias laborales)
//                DetalleTurnoVO detalleTurnoRotLaboral = 
//                    detalleTurnoRotaBp.getDetalleTurnoLaboralByFecha(_empleado.getEmpresa().getId(), 
//                    _empleado.getRut(), 
//                    Integer.parseInt(strAnio), 
//                    Integer.parseInt(strMes), IT_FECHA);
//                
//                //Rescata detalle turno rotativo (dias libres)
//                DetalleTurnoVO detalleTurnoRotLibre = 
//                    detalleTurnoRotaBp.getDetalleTurnoLibreByFecha(_empleado.getEmpresa().getId(), 
//                    _empleado.getRut(), 
//                    Integer.parseInt(strAnio), 
//                    Integer.parseInt(strMes), IT_FECHA);
                
                //rescatar detalle turno del empleado
                LinkedHashMap<Integer,DetalleTurnoVO> auxListDetalleTurno
                    = new LinkedHashMap<>();
                DetalleTurnoVO detalleturno = new DetalleTurnoVO();//
                
                if (asignacionTurnoRotativo != null){
                    tieneTurnoRotativo = true;
                    //auxListDetalleTurno.put(detalleTurnoRot.getIdTurno(), detalleTurnoRot);
                    detalleturno = asignacionTurnoRotativo;
                    //_listaDetalleTurnos.put(detalleTurnoRot.getIdTurno(), hashDetalleTurnoRotativo);
                }else{
                    auxListDetalleTurno = _listaDetalleTurnos.get(_empleado.getIdTurno());
                    detalleturno = auxListDetalleTurno.get(codDia);
                }
                if (!tieneTurnoRotativo){
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]procesaAsistencia."
                        + "Itera fecha " + IT_FECHA + ", tiene Turno Normal. set ambas marcas...");
                    marcas = marcasBp.getMarcasEmpleado(_empleado.getEmpresa().getId(), 
                        _empleado.getRut(), 
                        _fechasCalculo[i], _fechasCalculo[i]);
                }else{
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]procesaAsistencia."
                        + "Itera fecha " + IT_FECHA 
                        + ", tiene Turno Rotativo, buscar marca de entrada, "
                        + "sino tiene, buscar salida dia anterior. Add Marca");
                    MarcaVO auxMarca = marcasBp.getMarcaByTipo(_empleado.getEmpresa().getId(), 
                        _empleado.getRut(), 
                        _fechasCalculo[i], _fechasCalculo[i],1,null);
                                        
                    if (auxMarca != null){
                        System.out.println("[GestionFemase.CalculoAsistenciaBp]"
                            + "procesaAsistencia.AddMarca entrada...");
                        marcas.put("1", auxMarca);
                    }else{
                        System.out.println("[GestionFemase."
                            + "CalculoAsistenciaBp]procesaAsistencia."
                            + "No hay marca de entrada "
                            + "para fecha " + IT_FECHA+", no procesar...");
                        continuar=false;
                        
                    }
                }
                
                if (continuar){
                    boolean esFeriado = _hashFeriados.containsKey(_fechasCalculo[i]);
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]"
                        + "procesaAsistencia."
                        + "Fecha: " + _fechasCalculo[i]
                        +" es feriado? " + esFeriado); 
                        //validar que para la fecha hayan dos marcas : entrada y salida, en caso contrario...alertar

                         /**
                            * si hay marcas {
                            *   -proceder al calculo de horas trabajadas para ese dia
                            *   -rescatar horas extras:
                            *       .- Si el dia corresponde a su turno, las hras extras se consideran al 50%
                            *       .- Si el dia NO corresponde a su turno, las hras extras se consideran al 100%
                            * 
                            * } de lo contrario { //si no hay marcas para la fecha
                            *      - rescatar ausencias para empleado + fecha_iteracion (permisos, licencias, vacaciones, permisos autorizados, etc)
                            *      - NO APLICAN HORAS EXTRAS, SIN MARCAS NO HAY HRS EXTRAS
                            * }
                         */

                         //rescata detalle turno
                        //LinkedHashMap<Integer,DetalleTurnoVO> auxListDetalleTurno = _listaDetalleTurnos.get(_empleado.getIdTurno());
        //                DetalleTurnoVO detalleturno = auxListDetalleTurno.get(codDia);
                        //hrs contrato segun turno
                        int horasTeoricas   = 0;
                        int minutosTeoricos = 0;
                        String hhmmTurno    = "";
                        if (detalleturno != null){
                            horasTeoricas = detalleturno.getTotalHoras();
                            minutosTeoricos = horasTeoricas * 60;
                            DiferenciaHorasVO duracionTurno = 
                            Utilidades.restaHoras(_fechasCalculo[i]+" " +detalleturno.getHoraEntrada(), _fechasCalculo[i]+" " +detalleturno.getHoraSalida());
                                hhmmTurno = duracionTurno.getStrDiferenciaHorasMinutos();
                        }

                        System.out.println("[GestionFemase."
                            + "CalculoAsistenciaBp]procesaAsistencia."
                            + "Fecha calculo: "+_fechasCalculo[i]
                            + ", codDia: "+codDia
                            + ", rut: " + _empleado.getRut()
                            + ", idTurno: " + _empleado.getIdTurno()
                            + ", horasTeoricas: " + horasTeoricas
                            + ", tieneTurnoRotativo: " + tieneTurnoRotativo    
                        );

                        //rescata horas extras ingresadas y autorizadas previamente
            //            TiempoExtraVO hrsExtras = 
            //                tiempoExtraBp.getTiempoExtra(_empleado.getRut(), _fechasCalculo[i]);
                        //rescata tipos de horas extras ingresadas y autorizadas previamente
            //            HashMap<String,Integer> hashTiposHE = tiempoExtraBp.getTiposHrasExtras();
                        System.out.println("[GestionFemase."
                            + "CalculoAsistenciaBp]procesaAsistencia. "
                            + "Fecha calculo: "+_fechasCalculo[i]
                            + ", codDia: "+codDia
                            + ", rut: " + _empleado.getRut()
                            + ", size marcas: " +marcas.size());
                        if (!marcas.isEmpty()){
                            if (marcas.size() == 1){
                                System.out.println("[GestionFemase."
                                    + "CalculoAsistenciaBp]"
                                    + "procesaAsistencia.Tiene una sola marca...");
                                DetalleAsistenciaVO detalleCalculo = new DetalleAsistenciaVO();
                                detalleCalculo.setFechaHoraCalculo(fullFechaFmt.format(mycal.getTime()));
                                detalleCalculo.setEmpresaId(_empleado.getEmpresa().getId());
                                detalleCalculo.setDeptoId(_empleado.getDepartamento().getId());
                                detalleCalculo.setCencoId(_empleado.getCentroCosto().getId());
                                detalleCalculo.setRutEmpleado(_empleado.getRut());
                                String labelAlert="";
                                String auxAlert="";
                                Iterator<MarcaVO> collMarcas1 = marcas.values().iterator();
                                while(collMarcas1.hasNext()){//while 7
                                    MarcaVO currentMarca = collMarcas1.next();
                                    int tipoMarca1 = currentMarca.getTipoMarca();
                                    auxAlert = "Solo tiene marca ";
                                    labelAlert = currentMarca.getFechaHora()+", solo marca ";
                                    String fechaHoraMarcaFull = currentMarca.getFechaHora();//full =  incluye los segundos
                                    //2017-06-01 09:00:01
                                    StringTokenizer tokenFechaHora = new StringTokenizer(fechaHoraMarcaFull, " ");
                                    StringTokenizer tokenFecha = new StringTokenizer(tokenFechaHora.nextToken(), "-");
                                    StringTokenizer tokenHora = new StringTokenizer(tokenFechaHora.nextToken(), ":");
                                    String fechaMarca1 = tokenFecha.nextToken() + "-" + tokenFecha.nextToken() + "-" + tokenFecha.nextToken();
                                    String horaMarcaFull = tokenHora.nextToken() + ":" + tokenHora.nextToken() + ":" + tokenHora.nextToken();//considera los segundos de la hora
                                    //String horaMarcaShort = tokenHora.nextToken() + ":" + tokenHora.nextToken() + ":00";//seteo en cero mlos segundos
                                    String horaMarcaShort = horaMarcaFull.substring(0, horaMarcaFull.length()-3) + ":00";//no considerar los segundos
                                    if (tipoMarca1 == 1) {
                                        labelAlert += "Entrada";
                                        auxAlert += "Entrada";
                                        System.out.println("[GestionFemase."
                                            + "CalculoAsistenciaBp]"
                                            + "procesaAsistencia."
                                            + "Solo hay marca de ENTRADA. auxAlert= "+auxAlert);
                                        System.out.println("[GestionFemase.CalculoAsistenciaBp]"
                                            + "procesaAsistencia. setFechaEntradaMarca: "+fechaMarca1);
                                        detalleCalculo.setFechaEntradaMarca(fechaMarca1);
                                        detalleCalculo.setHoraEntrada(horaMarcaFull);//fecha hora entrada full
                                        if (tieneTurnoRotativo){
                                            System.out.println("[GestionFemase."
                                                + "CalculoAsistenciaBp]procesaAsistencia."
                                                + "Buscar marca de salida");
                                            MarcaVO auxMarca = getMarcaTurnoRotativo(marcasBp, _empleado, _fechasCalculo[i], horaMarcaFull, tipoMarca1);
                                            if (auxMarca != null){
                                                marcas.put("2", auxMarca);
                                            }
                                        }
                                    }else {
                                        labelAlert += "Salida";
                                        auxAlert += "Salida";
                                        System.out.println("[GestionFemase."
                                            + "CalculoAsistenciaBp]procesaAsistencia."
                                            + "Solo hay marca de SALIDA. auxAlert= "+auxAlert);
                                        detalleCalculo.setFechaEntradaMarca(_fechasCalculo[i]);
                                        detalleCalculo.setFechaSalidaMarca(fechaMarca1);
                                        detalleCalculo.setHoraSalida(horaMarcaFull);//fecha hora salida full
                                        if (tieneTurnoRotativo){
                                            System.out.println("[GestionFemase."
                                                + "CalculoAsistenciaBp]"
                                                + "procesaAsistencia."
                                                + "Buscar marca de entrada");
                                            MarcaVO auxMarca = getMarcaTurnoRotativo(marcasBp, _empleado, _fechasCalculo[i], horaMarcaFull, tipoMarca1);
                                            if (auxMarca != null){
                                                marcas.put("1", auxMarca);
                                            }
                                        }
                                    }

                                }//

                                if (marcas.size()==1){
                                    //auxAlert = labelAlert;
                                    labelAlert = "rut:" + _empleado.getRut()
                                        +", fecha: "+labelAlert;

                                    System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.- "
                                       + "empresa:" + _empleado.getEmpresa().getId()
                                       + ", rut:" + _empleado.getRut()
                                       + ", fecha: " + _fechasCalculo[i] 
                                       + ". Alerta: " + labelAlert
                                       + ". observacion: " + auxAlert);

                                   ArrayList<DetalleAusenciaVO> detalleausencia = 
                                       detalleAusenciaBp.getAusencias(_empleado.getRut(), 
                                           _fechasCalculo[i]);
                                   System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.NO TIENE MARCAS, "
                                        + "Set observacion[4]: " + auxAlert);
                                   detalleCalculo.setObservacion(auxAlert);
                                   detalleCalculo.setFechaCalculo(_fechasCalculo[i]);
                                   detalleCalculo.setHorasTeoricas(horasTeoricas);
                                   detalleCalculo.setArt22(_empleado.isArticulo22());
                                   if (detalleturno != null){
                                       detalleCalculo.setHoraEntradaTeorica(detalleturno.getHoraEntrada());
                                       detalleCalculo.setHoraSalidaTeorica(detalleturno.getHoraSalida());
                                       detalleCalculo.setHolguraMinutos(detalleturno.getHolguraMinutos());
                                   }else{
                                       String aux11 = detalleCalculo.getObservacion();
                                       System.out.println("[GestionFemase."
                                            + "CalculoAsistenciaBp]"
                                            + "procesaAsistencia.NO TIENE MARCAS, "
                                            + "Set observacion[3]: " + auxAlert);
                                       detalleCalculo.setObservacion("Sin turno - " + auxAlert);
                                   }
                                   detalleCalculo.setEsFeriado(_hashFeriados.containsKey(_fechasCalculo[i]));
                                    //iterando ausencias
                                   if (detalleausencia != null && detalleausencia.size() > 0){
                                        System.out.println("[GestionFemase."
                                            + "CalculoAsistenciaBp]"
                                            + "procesaAsistencia."
                                            + "[A]Iterando ausencias...");
                                        String auxMsgAusencias = "";
                                        ArrayList<String> listaHrsAusencias = new ArrayList<>();
                                        Iterator<DetalleAusenciaVO> ausenciasIterator = detalleausencia.iterator();
                                        while (ausenciasIterator.hasNext()) {
                                            DetalleAusenciaVO ausencia = ausenciasIterator.next();
                                            auxMsgAusencias += ausencia.getNombreAusencia();
                                            if (ausencia.getPermiteHora().compareTo("S") == 0){
                                                auxMsgAusencias += ausencia.getNombreAusencia()
                                                    +":" + ausencia.getHoraInicioFullAsStr().substring(0, ausencia.getHoraInicioFullAsStr().length()-3) 
                                                    +"-" + ausencia.getHoraFinFullAsStr().substring(0, ausencia.getHoraFinFullAsStr().length()-3)+" hrs, ";
                                                //restar hrs con fecha
                                                DiferenciaHorasVO difAusencia = Utilidades.restaHoras(_fechasCalculo[i] + " " + ausencia.getHoraInicioFullAsStr() +":00", 
                                                        _fechasCalculo[i] + " " + ausencia.getHoraFinFullAsStr()+":00");
                                                listaHrsAusencias.add(difAusencia.getStrDiferenciaHorasMinutos());
                                            }else{
                                                auxMsgAusencias += ausencia.getNombreAusencia();
                                                if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
                                                    listaHrsAusencias.add(hhmmTurno);
                                                }
                                                //hrs justificadas = suma de hrs de ausencia...
                                            }
                                        }
                                        
                                        System.out.println("[GestionFemase."
                                            + "CalculoAsistenciaBp]"
                                            + "procesaAsistencia."
                                            + "NO TIENE MARCAS, "
                                            + "Set observacion[2]: " + auxMsgAusencias);
                                        detalleCalculo.setObservacion(auxMsgAusencias);
                                        String sumaJustificadas = Utilidades.sumTimesList(listaHrsAusencias);
                                        detalleCalculo.setHhmmJustificadas(sumaJustificadas);
                                        //detalleCalculo.setHoraInicioAusencia(detalleausencia.getHoraInicioFullAsStr());
                                        //detalleCalculo.setHoraFinAusencia(detalleausencia.getHoraFinFullAsStr());
                                   }
                                   
                                    System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia."
                                        + "**1** Put detalleCalculo."
                                         + " Rut="+_empleado.getRut()
                                         + ",fecha entrada="+detalleCalculo.getFechaEntradaMarca()
                                         +", hora Entrada="+detalleCalculo.getHoraEntrada());
                                   listaAux.add(detalleCalculo);
//                                   listaDetalleCalculoReturn.put(detalleCalculo.getFechaEntradaMarca()
//                                        +"|"+detalleCalculo.getHoraEntrada()
//                                        +"|"+_empleado.getRut(), detalleCalculo);
                ////                   objCorreo.setSmtpHost(appProperties.getMailHost());
                ////                   objCorreo.setSmtpPort(appProperties.getMailPort());
                ////                   objCorreo.setFrom(appProperties.getMailFrom());
                ////                   objCorreo.setDestinatarios(appProperties.getMailTo());
                ////                   objCorreo.setSubject("Femase-Sistema Gestion");
                ////                   objCorreo.setBody(labelAlert);
                ////                    try {
                ////                        objCorreo.setEnviarMensaje();
                ////                    } catch (Exception ex) {
                ////                        System.err.println("Error al enviar "
                ////                            + "correo: "+ex.toString());
                ////                    }
                                }
                            }
                            if (marcas.size() > 1){
                                //ordenar par de marcas...
                                MarcaVO marcaEntrada = marcas.get("1");
                                MarcaVO marcaSalida = marcas.get("2");
                                System.out.println("[GestionFemase."
                                    + "CalculoAsistenciaBp]"
                                    + "procesaAsistencia."
                                    + "FechaHora entrada: "+marcaEntrada.getFechaHora()
                                    + ", fechaHora salida: "+marcaSalida.getFechaHora()    
                                );
                                LinkedHashMap<String, MarcaVO> marcasOrdenadas = 
                                    new LinkedHashMap<>();
                                marcasOrdenadas.put("1", marcaEntrada);
                                marcasOrdenadas.put("2", marcaSalida);
                                m_marcasProcesadas.put(marcaEntrada.getFechaHora(), marcaEntrada);
                                m_marcasProcesadas.put(marcaSalida.getFechaHora(), marcaSalida);
                                //listaDetalleCalculoReturn = getInfoAsistencia(_empleado, marcas);
                                DetalleAsistenciaVO auxDetalleCalculo = getInfoAsistencia(_empleado, marcasOrdenadas, detalleturno, 
                                    horasTeoricas, _hashFeriados, 
                                    minutosTeoricos, asignacionTurnoRotativo, 
                                    _hashTiposHE);
                                
                                listaAux.add(auxDetalleCalculo);
                                
                                System.out.println("[GestionFemase."
                                    + "CalculoAsistenciaBp]"
                                    + "procesaAsistencia.**ZZ** "
                                    + "put Key= " + _empleado.getRut() 
                                    + "|" + auxDetalleCalculo.getFechaEntradaMarca()
                                    + "|"+ auxDetalleCalculo.getHoraEntrada()
                                    +", observacion: "+auxDetalleCalculo.getObservacion());
//                                listaDetalleCalculoReturn.put(_empleado.getRut()+"|"+marcaEntrada.getHora(),
//                                    auxDetalleCalculo);
                            }
                            Iterator<DetalleAsistenciaVO> itDetails11 = listaAux.iterator();
                            while (itDetails11.hasNext())//while 9
                            {   
                                DetalleAsistenciaVO calculosFecha22 = itDetails11.next();
                                System.out.println("[GestionFemase."
                                    + "CalculoAsistenciaBp]"
                                    + "procesaAsistencia.**INTERMEDIO** detalleCalculo."
                                    + " Rut= " + _empleado.getRut()
                                    + ",fecha entrada= " + calculosFecha22.getFechaEntradaMarca()
                                    +", hora Entrada= " + calculosFecha22.getHoraEntrada());
                            }
                        }else{ // NO HAY MARCAS
                                /**
                                 * - rescatar ausencias para empleado + fecha_iteracion (permisos, licencias, vacaciones, permisos autorizados, etc)
                                 * - NO APLICAN HORAS EXTRAS, SIN MARCAS NO HAY HRS EXTRAS
                                 */

                                System.out.println("[GestionFemase."
                                    + "CalculoAsistenciaBp]"
                                    + "procesaAsistencia. "
                                    + "empresa:"+ _empleado.getEmpresa().getId()
                                    + ", rut:"+ _empleado.getRut()
                                    + ", fecha: " + _fechasCalculo[i] 
                                    + "- NO TIENE MARCAS, rescatar ausencias...");
                                ArrayList<DetalleAusenciaVO> detalleausencia = 
                                   detalleAusenciaBp.getAusencias(_empleado.getRut(), 
                                       _fechasCalculo[i]);
                                DetalleAsistenciaVO detalleCalculo = new DetalleAsistenciaVO();
                                detalleCalculo.setFechaHoraCalculo(fullFechaFmt.format(mycal.getTime()));
                                detalleCalculo.setEmpresaId(_empleado.getEmpresa().getId());
                                detalleCalculo.setDeptoId(_empleado.getDepartamento().getId());
                                detalleCalculo.setCencoId(_empleado.getCentroCosto().getId());
                                detalleCalculo.setRutEmpleado(_empleado.getRut());
                                detalleCalculo.setFechaCalculo(_fechasCalculo[i]);
                                detalleCalculo.setHorasTeoricas(horasTeoricas);
                                detalleCalculo.setArt22(_empleado.isArticulo22());
                                //String hhmmTurno = "";

                                if (detalleturno != null){
                                   System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.-0- fechaHra1: "+_fechasCalculo[i]+" " +detalleturno.getHoraEntrada()+
                                        "fechaHra2: "+_fechasCalculo[i]+" " +detalleturno.getHoraSalida());
                                   DiferenciaHorasVO duracionTurno = 
                                        Utilidades.restaHoras(_fechasCalculo[i]+" " +detalleturno.getHoraEntrada(), _fechasCalculo[i]+" " +detalleturno.getHoraSalida());
                                   hhmmTurno = duracionTurno.getStrDiferenciaHorasMinutos();
                                   detalleCalculo.setHoraEntradaTeorica(detalleturno.getHoraEntrada());
                                   detalleCalculo.setHoraSalidaTeorica(detalleturno.getHoraSalida());
                                   detalleCalculo.setHolguraMinutos(detalleturno.getHolguraMinutos());
                                   System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.NO TIENE MARCAS "
                                        + "hhmmTurno:"+ hhmmTurno);
                                }
                                detalleCalculo.setEsFeriado(_hashFeriados.containsKey(_fechasCalculo[i]));
                                if (detalleausencia != null && detalleausencia.size() > 0){
                                    System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.[B]Iterando ausencias...");
                                    String auxMsgAusencias = "";
                                    ArrayList<String> listaHrsAusencias=new ArrayList<String>();
                                    //iterando ausencias
                                    Iterator<DetalleAusenciaVO> ausenciasIterator = detalleausencia.iterator();
                                    while (ausenciasIterator.hasNext()) {
                                        DetalleAusenciaVO ausencia = ausenciasIterator.next();
                                        //auxMsgAusencias += ausencia.getNombreAusencia();
                                        if (ausencia.getPermiteHora().compareTo("S")==0){
                                            auxMsgAusencias += ausencia.getNombreAusencia()
                                                +":" + ausencia.getHoraInicioFullAsStr().substring(0, ausencia.getHoraInicioFullAsStr().length()-3) 
                                                +"-" + ausencia.getHoraFinFullAsStr().substring(0, ausencia.getHoraFinFullAsStr().length()-3)+" hrs, ";
                                            //restar hrs con fecha
                                            DiferenciaHorasVO difAusencia = Utilidades.restaHoras(_fechasCalculo[i] + " " + ausencia.getHoraInicioFullAsStr() +":00", 
                                                    _fechasCalculo[i] + " " + ausencia.getHoraFinFullAsStr()+":00");
                                            listaHrsAusencias.add(difAusencia.getStrDiferenciaHorasMinutos());
                                        }else{
                                            auxMsgAusencias += ausencia.getNombreAusencia();
                                            if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
                                                listaHrsAusencias.add(hhmmTurno);
                                            }
                                            //hrs justificadas = suma de hrs de ausencia...
                                        }
                                    }
                                    
                                    System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.NO TIENE MARCAS, "
                                        + "Set observacion[12]: " + auxMsgAusencias);
                                    detalleCalculo.setObservacion(auxMsgAusencias);
                                    detalleCalculo.setHhmmJustificadas(Utilidades.sumTimesList(listaHrsAusencias));
                                                                        
//                                    if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
//                                        System.out.println("[DetalleAsistenciaController.procesaAsistencia]NO TIENE MARCAS "
//                                            + "Set hrs ausencia con hrsTurno: "+ hhmmTurno);
//                                        detalleCalculo.setHhmmJustificadas(hhmmTurno);
//                                    }
                                    
                                }else{
                                    System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia."
                                        + "empresa:"+ _empleado.getEmpresa().getId()
                                        + ", rut:"+ _empleado.getRut()
                                        + ", fecha: " + _fechasCalculo[i] 
                                        + "- No tiene ausencias. "
                                        + "HH:MM turno: " + hhmmTurno);
                                    //No tiene marcas ni ausencia...
                                    if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
                                        System.out.println("[GestionFemase."
                                            + "CalculoAsistenciaBp]"
                                            + "procesaAsistencia."
                                            + ", rut:"+ _empleado.getRut()
                                            + ", fecha: " + _fechasCalculo[i] 
                                            + "- Set hrs ausencia= " + hhmmTurno 
                                            + " y observacion = Sin marcas" );
                                        if (detalleturno != null){
                                            //detalleCalculo.setHoraEntrada(detalleturno.getHoraEntrada());
                                            //detalleCalculo.setHoraSalida(detalleturno.getHoraSalida());
                                            detalleCalculo.setFechaSalidaMarca(_fechasCalculo[i]);
                                        }
                                        if (!esFeriado){
                                            System.out.println("[GestionFemase."
                                                + "CalculoAsistenciaBp]"
                                                + "procesaAsistencia.NO TIENE MARCAS "
                                                + "Set hrs ausencia con hrsTurno: "+ hhmmTurno);
                                            detalleCalculo.setHrsAusencia(hhmmTurno);
                                        }
                                        System.out.println("[GestionFemase."
                                            + "CalculoAsistenciaBp]"
                                            + "procesaAsistencia.NO TIENE MARCAS, "
                                            + "Set observacion[11]. hh:mm turno: "+hhmmTurno);
//                                        if (esFeriado){
//                                            detalleCalculo.setObservacion("Feriado");
//                                        }else{
//                                            detalleCalculo.setObservacion("Sin marcas");
//                                        }

                                        if (esFeriado && (hhmmTurno.compareTo("")!=0)){
                                            detalleCalculo.setObservacion("Feriado");
                                        }else if (esFeriado && (hhmmTurno.compareTo("")==0)){
                                            detalleCalculo.setObservacion("Libre");
                                        }else if (!esFeriado && hhmmTurno.compareTo("")!=0){
                                            detalleCalculo.setObservacion("Sin marcas");
                                        }
                                    
                                    }
                                }

//                                if (detalleTurnoRotLibre!=null){
//                                    System.err.println("[GestionFemase."
//                                        + "CalculoAsistenciaBp]"
//                                        + "procesaAsistencia.Set observacion= dia libre");
//                                    System.out.println("[GestionFemase."
//                                        + "CalculoAsistenciaBp]"
//                                        + "procesaAsistencia.NO TIENE MARCAS, "
//                                        + "Set observacion[10]");
//                                    detalleCalculo.setObservacion("Dia libre");
//                                }

                                if (detalleCalculo.getFechaEntradaMarca() != null){
                                    System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.**2** put detalleCalculo."
                                        + " Rut="+_empleado.getRut()
                                        + ",fecha entrada="+detalleCalculo.getFechaEntradaMarca()
                                        +", hora Entrada="+detalleCalculo.getHoraEntrada());
                                }else{
                                    detalleCalculo.setFechaCalculo(_fechasCalculo[i]);
                                    detalleCalculo.setFechaEntradaMarca(_fechasCalculo[i]);
                                    System.out.println("[GestionFemase."
                                        + "CalculoAsistenciaBp]"
                                        + "procesaAsistencia.NO TIENE MARCAS, "
                                        + "Set observacion[9], "
                                        + "hh:mm turno: "+hhmmTurno
                                        +", detalleausencia: "+detalleausencia);
                                    if (detalleausencia == null || detalleausencia.isEmpty()){
                                        System.err.println("Aqui 1");
                                        if (esFeriado && (hhmmTurno != null && hhmmTurno.compareTo("")!=0)){
                                            System.err.println("[GestionFemase."
                                                + "CalculoAsistenciaBp]"
                                                + "procesaAsistencia."
                                                + "Set Obs = feriado");
                                            detalleCalculo.setObservacion("Feriado");
                                        }else if (esFeriado && (hhmmTurno != null && hhmmTurno.compareTo("") == 0)){
                                            System.err.println("[GestionFemase."
                                                + "CalculoAsistenciaBp]"
                                                + "procesaAsistencia."
                                                + "Set Obs = Libre");
                                            detalleCalculo.setObservacion("Libre");
                                        }else if (!esFeriado && hhmmTurno.compareTo("")!=0){
                                            detalleCalculo.setObservacion("Sin marcas");
                                        }
                                    }
                                }
                                listaAux.add(detalleCalculo);
                        }
                }//fin if continuar

            }//fin iteracion de fechas
        
        Iterator<DetalleAsistenciaVO> itDetails11 = listaAux.iterator();
        while (itDetails11.hasNext())//while 9
        {   
            DetalleAsistenciaVO calculosFecha22 = itDetails11.next();
            System.out.println("[GestionFemase."
                + "CalculoAsistenciaBp]"
                + "procesaAsistencia."
                + "**ANTES DE SALIR** "
                + "detalleCalculo."
                + " Rut= " + _empleado.getRut()
                + ",fecha entrada= " + calculosFecha22.getFechaEntradaMarca()
                +", hora Entrada= " + calculosFecha22.getHoraEntrada());
        }
           
        return listaAux;
    }
    
    private DetalleAsistenciaVO getInfoAsistencia(EmpleadoVO _empleado, 
            LinkedHashMap<String, MarcaVO> _listaMarcas, 
            DetalleTurnoVO _detalleturno,
            int _horasTeoricas,
            HashMap<String,String> _hashFeriados,
            int _minutosTeoricos,
            DetalleTurnoVO _detalleTurnoRotLibre,
            HashMap<String,Integer> _hashTiposHE){
    
        //Tiene las dos marcas en la misma fecha
        DetalleAsistenciaVO auxDetalleCalculoReturn=new DetalleAsistenciaVO();
        int tipoMarca;
        String fechaHoraMarca;
        String fechaMarca;
        String horaMarca;
        String comentarioMarca="";
        String horaMarcaFull;
        String fechaEntrada  = "";
        String fechaSalida  = "";
        
        String horaEntrada  = "";
        String horaSalida   = "";
        String comentarioEntrada  = "";
        String comentarioSalida   = "";
        String horaEntradaFull  = "";
        String horaSalidaFull   = "";
        System.out.println("[GestionFemase."
            + "CalculoAsistenciaBp]"
            + "getInfoAsistencia(). "
            + "Ordenando marcas");
                
        LinkedHashMap<String, DetalleMarcaVO> marcasOrdenadas 
            = new LinkedHashMap<>();
        SimpleDateFormat soloFechaFmt = new SimpleDateFormat("yyyy-MM-dd");
        SimpleDateFormat fullFechaFmt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        Calendar mycal = Calendar.getInstance();
        DetalleAusenciaBp detalleAusenciaBp = new DetalleAusenciaBp(new PropertiesVO());
        Iterator<MarcaVO> collMarcas = _listaMarcas.values().iterator();
        while(collMarcas.hasNext()){//while 7
            MarcaVO currentMarca = collMarcas.next();
            
            tipoMarca = currentMarca.getTipoMarca();
            fechaHoraMarca = currentMarca.getFechaHora();
            comentarioMarca = currentMarca.getComentario();
            //2017-06-01 09:00:01
            StringTokenizer tokenFechaHora = new StringTokenizer(fechaHoraMarca, " ");
            StringTokenizer tokenFecha = new StringTokenizer(tokenFechaHora.nextToken(), "-");
            StringTokenizer tokenHora = new StringTokenizer(tokenFechaHora.nextToken(), ":");
            fechaMarca = tokenFecha.nextToken() + "-" + tokenFecha.nextToken() + "-" + tokenFecha.nextToken();
            horaMarcaFull = tokenHora.nextToken() + ":" + tokenHora.nextToken() + ":" + tokenHora.nextToken();//considera los segundos
            horaMarca = horaMarcaFull.substring(0, horaMarcaFull.length()-3) + ":00";//no considerar los segundos
            System.out.println("[GestionFemase."
            + "CalculoAsistenciaBp]"
                + "getInfoAsistencia(). "
                + "fechaMarca: "+fechaMarca
                + ", tipoMarca: "+tipoMarca
                + ", horaMarca para calculos: "+horaMarca
                + ", horaMarca full: "+horaMarcaFull
                + ", comentarioMarca: "+comentarioMarca);
            
            //error al iterar marcas...debe tomar la marca de entrada primero...
            if (tipoMarca == 1){
                fechaEntrada = fechaMarca;
                horaEntrada = horaMarca;
                horaEntradaFull = horaMarcaFull;
                comentarioEntrada = comentarioMarca; 
            }else{
                fechaSalida = fechaMarca;
                horaSalida = horaMarca;
                horaSalidaFull = horaMarcaFull;
                comentarioSalida = comentarioMarca;
                System.out.println("[GestionFemase."
                    + "CalculoAsistenciaBp]."
                    + "getInfoAsistencia(). "
                    + "empresaId: "+_empleado.getEmpresa().getId()
                    + ", rutEmpleado: "+_empleado.getRut()
                    + ", fechaEntrada: "+fechaEntrada
                    + ", horaEntrada: "+horaEntrada
                    + ", comentarioEntrada: "+comentarioEntrada
                    + ", fechaSalida: "+fechaSalida
                    + ", horaSalida: "+horaSalida
                    + ", comentarioSalida: "+comentarioSalida);
                DetalleMarcaVO detalleMarca = new DetalleMarcaVO(_empleado.getEmpresa().getId(), 
                    _empleado.getRut(),
                    horaEntrada,
                    horaSalida,
                    horaEntradaFull,
                    horaSalidaFull,    
                    fechaEntrada,
                    fechaSalida,
                    comentarioEntrada,
                    comentarioSalida);
                marcasOrdenadas.put(fechaMarca, detalleMarca);

            }

        }//fin while 7

        //iterar marcas ordenadas
        Iterator<DetalleMarcaVO> collMarcasOrdenadas = marcasOrdenadas.values().iterator();
        while(collMarcasOrdenadas.hasNext()){//while 8
            DetalleMarcaVO currentMarca = collMarcasOrdenadas.next();
            String hhmmTeoricas = "";
            String hhmmPresencial = "";
            
            DiferenciaHorasVO diferenciaReal = new DiferenciaHorasVO();
            //if (_detalleturno != null){
                // Restar hora_salida - hora_entrada = hrs_efectivas
                System.out.println("[GestionFemase."
                    + "CalculoAsistenciaBp]"
                    + "getInfoAsistencia. "
                    + "Datos para Hrs presenciales: "+currentMarca.getFechaEntrada()+ " " + currentMarca.getHoraEntrada()
                    + ", fechaHora2: "+currentMarca.getFechaSalida() + " " + currentMarca.getHoraSalida());

                diferenciaReal = 
                    Utilidades.restaHoras(currentMarca.getFechaEntrada()+ " " + currentMarca.getHoraEntrada(), 
                        currentMarca.getFechaSalida()+" " +currentMarca.getHoraSalida());
                hhmmPresencial = diferenciaReal.getStrDiferenciaHorasMinutos();
            //}
            
            if (_detalleturno != null){
                DiferenciaHorasVO diferenciaTeorica = 
                    Utilidades.restaHoras(currentMarca.getFechaEntrada()
                        + " " + _detalleturno.getHoraEntrada(), 
                        currentMarca.getFechaSalida() 
                        + " " + _detalleturno.getHoraSalida());
                hhmmTeoricas = diferenciaTeorica.getStrDiferenciaHorasMinutos();
            }else{
                System.out.println("[GestionFemase."
                    + "CalculoAsistenciaBp]"
                    + "getInfoAsistencia. No tiene turno!!");
            }
            
            int horasReales = diferenciaReal.getIntDiferenciaHoras();
            int minutosReales = diferenciaReal.getIntDiferenciaMinutos();
            int minutosExtras = 0;
            int minutosAtraso = 0;
            int minutosNoTrabajadosEntrada = 0;
            int minutosNoTrabajadosSalida = 0;
            
            /**
             * Set cabecera calculo asistencia
             */
            String hhmmExtras = "00:00";
            DetalleAsistenciaVO detalleCalculo = new DetalleAsistenciaVO();
            detalleCalculo.setFechaHoraCalculo(fullFechaFmt.format(mycal.getTime()));
            detalleCalculo.setEmpresaId(_empleado.getEmpresa().getId());
            detalleCalculo.setDeptoId(_empleado.getDepartamento().getId());
            detalleCalculo.setCencoId(_empleado.getCentroCosto().getId());
            detalleCalculo.setRutEmpleado(_empleado.getRut());
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia**2** "
                + "setFechaEntradaMarca: " + currentMarca.getFechaEntrada());
            detalleCalculo.setFechaEntradaMarca(currentMarca.getFechaEntrada());
            detalleCalculo.setHoraEntrada(currentMarca.getHoraEntradaFull());//fecha hora entrada full
            detalleCalculo.setFechaSalidaMarca(currentMarca.getFechaSalida());
            detalleCalculo.setHoraSalida(currentMarca.getHoraSalidaFull());//fecha hora salida full
            detalleCalculo.setHorasTeoricas(_horasTeoricas);
            detalleCalculo.setHorasReales(horasReales);
            detalleCalculo.setMinutosReales(minutosReales);
            detalleCalculo.setComentarioMarcaEntrada(comentarioEntrada);
            detalleCalculo.setComentarioMarcaSalida(comentarioSalida);
            //added 01-11-2017
            
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia"
                + "--1-- setHrsPresenciales= " 
                + diferenciaReal.getStrDiferenciaHorasMinutos()); 
            detalleCalculo.setHrsPresenciales(diferenciaReal.getStrDiferenciaHorasMinutos());

            detalleCalculo.setArt22(_empleado.isArticulo22());
            if (_detalleturno != null){
                detalleCalculo.setHoraEntradaTeorica(_detalleturno.getHoraEntrada());
                detalleCalculo.setHoraSalidaTeorica(_detalleturno.getHoraSalida());
                detalleCalculo.setHolguraMinutos(_detalleturno.getHolguraMinutos());
            }else{
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                    + "NO TIENE MARCAS, "
                    + "Set observacion[8]");
                detalleCalculo.setObservacion("Sin turno");
            }
            
            detalleCalculo.setEsFeriado(_hashFeriados.containsKey(currentMarca.getFechaEntrada()));//
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                + "Fecha marca entrada: "+currentMarca.getFechaEntrada()
                + ",Fecha marca salida: "+currentMarca.getFechaSalida()
                + ",Minutos Reales= "+minutosReales
                +", Minutos teoricos= "+_minutosTeoricos);
            int comparaHrsRealesTeoricas = Utilidades.comparaHoras(currentMarca.getFechaEntrada()
                + " " + hhmmTeoricas+":00", 
                    currentMarca.getFechaEntrada() + " " + hhmmPresencial+":00");
            DiferenciaHorasVO diferenciaNTSalida=new DiferenciaHorasVO();
            //if (minutosReales > _minutosTeoricos){
            if (comparaHrsRealesTeoricas == 1){    
                
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                    + "Seteo de hrs extras. Restar horas-"
                    + " hhmmPresencial: " + hhmmPresencial
                    + ",hhmmTeoricas: "+hhmmTeoricas);
                
                DiferenciaHorasVO diferencia99 = 
                    Utilidades.restaHoras(currentMarca.getFechaEntrada()
                        + " " + hhmmPresencial+":00", 
                        currentMarca.getFechaEntrada() 
                        + " " + hhmmTeoricas+":00");
                hhmmExtras = diferencia99.getStrDiferenciaHorasMinutos();
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                    + "Setear hh:mm extras= "+hhmmExtras);
                detalleCalculo.setHoraMinsExtras(hhmmExtras);
            }else
            {
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                    + "Setear atraso..");
                //atraso
                if (minutosReales < _minutosTeoricos){
                    //le faltan minutos en la entrada o en la salida
                    if (_detalleturno != null){
                        String fechaHoraEntradaReal = currentMarca.getFechaEntrada()+" " +currentMarca.getHoraEntrada();
                        String fechaHoraSalidaReal = currentMarca.getFechaSalida()+" " +currentMarca.getHoraSalida();
                        String fechaHoraEntradaTeorica = currentMarca.getFechaEntrada()+" " +_detalleturno.getHoraEntrada();
                        String fechaHoraSalidaTeorica = currentMarca.getFechaSalida()+" " +_detalleturno.getHoraSalida();
                        System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                            + "fechaHoraEntradaReal: " + fechaHoraEntradaReal
                            + ",fechaHoraEntradaTeorica: " + fechaHoraEntradaTeorica);
                        if (Utilidades.comparaHoras(fechaHoraEntradaTeorica,fechaHoraEntradaReal)==1){
                            //hora entrada real es posterior a la hora de entrada teorica
                            DiferenciaHorasVO diferenciaNTEntrada = 
                                Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + currentMarca.getHoraEntrada(), 
                                    currentMarca.getFechaEntrada()+" " +_detalleturno.getHoraEntrada());
                            
                            minutosNoTrabajadosEntrada = 
                                (diferenciaNTEntrada.getIntDiferenciaMinutos()) - _detalleturno.getMinutosColacion();
                            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                                + "minutosNoTrabajadosEntrada= " + minutosNoTrabajadosEntrada
                                +", Setear atraso de hh:mm= " + diferenciaNTEntrada.getStrDiferenciaHorasMinutos());
                            detalleCalculo.setHhmmAtraso(diferenciaNTEntrada.getStrDiferenciaHorasMinutos());
                            if (minutosNoTrabajadosEntrada < 0) minutosNoTrabajadosEntrada = 0;
                        }
                        System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                            + "fechaHoraSalidaReal: " + fechaHoraSalidaReal
                            + ",fechaHoraSalidaTeorica: " + fechaHoraSalidaTeorica);
                        if (Utilidades.comparaHoras(fechaHoraSalidaReal,fechaHoraSalidaTeorica)==1){
                            //hora salida teorica es posterior a la hora de salida real
                            diferenciaNTSalida = 
                                Utilidades.restaHoras(currentMarca.getFechaSalida() + " " + currentMarca.getHoraSalida(), 
                                                      currentMarca.getFechaSalida()+" " +_detalleturno.getHoraSalida());
                            minutosNoTrabajadosSalida = 
                                (diferenciaNTSalida.getIntDiferenciaMinutos()) - _detalleturno.getMinutosColacion();
                            
                            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                                + "fechaHoraSalidaReal: " + fechaHoraSalidaReal
                                + ",fechaHoraSalidaTeorica: " + fechaHoraSalidaTeorica
                                + ",difHHMM: " + diferenciaNTSalida.getStrDiferenciaHorasMinutos());
                            
                            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                                + "minutosNoTrabajadosSalida= "+minutosNoTrabajadosSalida);
                            if (minutosNoTrabajadosSalida < 0) minutosNoTrabajadosSalida = 0;
                        }
                        DiferenciaHorasVO diferenciaAtraso = 
                                Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + _detalleturno.getHoraEntrada(), 
                                                      currentMarca.getFechaEntrada()+" " +currentMarca.getHoraEntrada());                    
                        minutosAtraso = diferenciaAtraso.getIntDiferenciaMinutos();
                        String h1 = currentMarca.getFechaEntrada() + " " + currentMarca.getHoraEntrada();//marca 
                        String h2 = currentMarca.getFechaEntrada()+" " +_detalleturno.getHoraEntrada();//turno
                        String hhmmAtraso = getHorasMinutosAtraso(h1, h2);
                        System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                            + "fechaHoraEntradaReal= " + h1
                            + ",fechaHoraEntradaTeorica= " + h2    
                            + ", hhmmAtraso= " + hhmmAtraso);
                        if (minutosAtraso < 0) minutosAtraso = 0;
                        detalleCalculo.setMinutosAtraso(minutosAtraso);
                        detalleCalculo.setHhmmAtraso(hhmmAtraso);
                        
                        detalleCalculo.setMinutosNoTrabajadosEntrada(minutosAtraso);
                        detalleCalculo.setMinutosNoTrabajadosSalida(minutosNoTrabajadosSalida);

                    }
                }
            }

            //added 01-11-2017
            /**
            * horaMinsTrabajados= (hh:mm turno) + (hh:mm marca_salida - hh:mm salida turno ) [B]
            * si (atraso > 0){
            *   horaMinsTrabajados =  horaMinsTrabajados - (hh:mm entrada turno - hh:mm marca_entrada) [C]
            * }
            */
            String hhmmTurno="";
            if (_detalleturno != null){
                System.err.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                    + "hora marca entrada = "+ currentMarca.getHoraEntrada()
                    +", hora turno entrada = "+ _detalleturno.getHoraEntrada()
                    + ",hora marca salida = "+ currentMarca.getHoraSalida()
                    +", hora turno salida = "+ _detalleturno.getHoraSalida()
                );
                
                DiferenciaHorasVO diferenciaEntradaTurno = 
                    Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + currentMarca.getHoraEntrada(), 
                                          currentMarca.getFechaEntrada()+" " +_detalleturno.getHoraEntrada());
                
                int auxMinsAtraso = diferenciaEntradaTurno.getIntDiferenciaMinutos(); 
                
                String h1 = currentMarca.getFechaEntrada() + " " + currentMarca.getHoraEntrada();//marca 
                String h2 = currentMarca.getFechaEntrada()+" " +_detalleturno.getHoraEntrada();//turno
                String hhmmAtraso = getHorasMinutosAtraso(h1, h2);
                String parteBEntrada = diferenciaEntradaTurno.getStrDiferenciaHorasMinutos();
                                
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.-1- "
                    + "fechaHra1: " + currentMarca.getFechaSalida() + " " + currentMarca.getHoraSalida()
                    + "fechaHra2: " + currentMarca.getFechaSalida()+" " +_detalleturno.getHoraSalida() 
                    + ", hhmmAtrasoX: " + hhmmAtraso);
                DiferenciaHorasVO diferenciaSalidaTurno = 
                    Utilidades.restaHoras(currentMarca.getFechaSalida() + " " + currentMarca.getHoraSalida(), 
                            currentMarca.getFechaSalida()+ " " + _detalleturno.getHoraSalida());
                int auxMinExtras = diferenciaSalidaTurno.getIntDiferenciaMinutos();  
                String parteBSalida = diferenciaSalidaTurno.getStrDiferenciaHorasMinutos();
                
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.-2- "
                    + "fechaHra1: "+currentMarca.getFechaEntrada() + " " + _detalleturno.getHoraEntrada()+
                    ", fechaHra2: "+currentMarca.getFechaSalida()+" " +_detalleturno.getHoraSalida());
                DiferenciaHorasVO diferenciaTurno = 
                    Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + _detalleturno.getHoraEntrada(), 
                                          currentMarca.getFechaSalida() + " " + _detalleturno.getHoraSalida());
                hhmmTurno = diferenciaTurno.getStrDiferenciaHorasMinutos();
                System.err.println("[GestionFemase.CalculoAsistenciaBp]"
                        + "getInfoAsistencia.hhmmTurno = "+ hhmmTurno
                    +", parteBEntrada = "+parteBEntrada
                    +", parteBSalida = "+parteBSalida
                    +", auxMinsAtraso = "+auxMinsAtraso
                    +", auxMinExtras = "+auxMinExtras);
                 
                /**
                 * Si hora marca salida es menor (anterior) a la hora de salida del turno
                 * Si hora marca entrada es mayor (posterior) a la hora de entrada del turno
                 * Se deben restar minutos a las hrs trabajadas
                 * 
                 */
                String hraEntradaMarca = soloFechaFmt.format(mycal.getTime()) + " " + currentMarca.getHoraEntrada();
                String hraEntradaTurno = soloFechaFmt.format(mycal.getTime()) + " " + _detalleturno.getHoraEntrada();
                String hraSalidaMarca = soloFechaFmt.format(mycal.getTime()) + " " + currentMarca.getHoraSalida();
                String hraSalidaTurno = soloFechaFmt.format(mycal.getTime()) + " " + _detalleturno.getHoraSalida();
                int comparahraEntrada = Utilidades.comparaHoras(hraEntradaMarca, hraEntradaTurno);
                int comparahraSalida = Utilidades.comparaHoras(hraSalidaTurno,hraSalidaMarca);
                System.err.println("[GestionFemase.CalculoAsistenciaBp]"
                    + "getInfoAsistencia."
                    + "comparahraEntrada = "+ comparahraEntrada
                    + ", comparahraSalida = "+ comparahraSalida+", hhmmAtraso: "+hhmmAtraso);

                if (auxMinsAtraso < 0) auxMinsAtraso = 0;
                detalleCalculo.setMinutosAtraso(auxMinsAtraso);
                detalleCalculo.setHhmmAtraso(hhmmAtraso);    
                
                if (diferenciaNTSalida != null 
                        && diferenciaNTSalida.getStrDiferenciaHorasMinutos()!=null
                        && diferenciaNTSalida.getStrDiferenciaHorasMinutos().compareTo("")==0 
                        && auxMinExtras > 0) 
                {   System.err.println("[GestionFemase.CalculoAsistenciaBp]"
                        + "getInfoAsistencia."
                        + " **1** setHrsExtras = "+ parteBSalida);
                    detalleCalculo.setMinutosExtras(auxMinExtras);   
                }
                if ( diferenciaNTSalida != null 
                        && diferenciaNTSalida.getStrDiferenciaHorasMinutos()!=null
                        && diferenciaNTSalida.getStrDiferenciaHorasMinutos().compareTo("") == 0)
                {
                    System.err.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                        + " **2** setHrsExtras = "+ parteBSalida);
                    detalleCalculo.setHoraMinsExtras(parteBSalida);
                }
                
                System.err.println("[GestionFemase."
                    + "CalculoAsistenciaBp]"
                    + "getInfoAsistencia. minsAtraso=" + auxMinsAtraso);

////                detalleCalculo.setHrsTrabajadas(horasMinsTrabajados);
            }else{
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                    + "NO TIENE MARCAS, "
                    + "Set observacion[7]");
                detalleCalculo.setObservacion("Sin turno");
                
////                DiferenciaHorasVO diferencia66 = 
////                    Utilidades.restaHoras(currentMarca.getFechaSalida() + " " + currentMarca.getHoraEntrada(), 
////                        currentMarca.getFechaSalida() + " " + currentMarca.getHoraSalida());
////                System.out.println("[getInfoAsistencia]-6- set horasMinsTrabajados");
////                horasMinsTrabajados = diferencia66.getStrDiferenciaHorasMinutos();
////                detalleCalculo.setHrsTrabajadas(horasMinsTrabajados);
////                System.out.println("[DetalleAsistenciaController."
////                    + "getInfoAsistencia]--2-- setHrsPresenciales= " 
////                    + horasMinsTrabajados); 
////                detalleCalculo.setHrsPresenciales(horasMinsTrabajados);
            }

            /**
             *  .- si hrs_efectivas > hrs_contrato --> verificar si el empleado tiene hrs extras aprobadas para la fecha_marca    
                .- si hrs_efectivas < hrs_contrato --> verificar si el empleado tiene hrs o dias de ausencia justificadas y aprobadas para la fecha_marca
             */
            //****buscando ausencias en fecha de entrada
            
            DetalleAusenciaVO detalleausenciaEntrada = 
                detalleAusenciaBp.getAusencia(_empleado.getRut(), currentMarca.getFechaEntrada());
            if (detalleausenciaEntrada != null){
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.Tiene ausencias en fecha de entrada!");
                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                    + "ausenciaHraInicio:" + detalleausenciaEntrada.getHoraInicioFullAsStr()
                    + ",ausenciaHraFin:" + detalleausenciaEntrada.getHoraFinFullAsStr()
                    + ",ausenciaTipo:" + detalleausenciaEntrada.getNombreAusencia()
                    + ",ausenciaPorHora?:" + detalleausenciaEntrada.getPermiteHora());
                detalleCalculo.setHoraInicioAusencia(detalleausenciaEntrada.getHoraInicioFullAsStr());
                detalleCalculo.setHoraFinAusencia(detalleausenciaEntrada.getHoraFinFullAsStr());
                if (detalleausenciaEntrada.getPermiteHora().compareTo("S") == 0){
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.-6- "
                        + "fechaHra1: "+currentMarca.getFechaEntrada() + " " + detalleausenciaEntrada.getHoraInicioFullAsStr()+
                        "fechaHra2: "+currentMarca.getFechaEntrada()+" " +detalleausenciaEntrada.getHoraFinFullAsStr());
                    DiferenciaHorasVO diferencia7 = 
                        Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + detalleausenciaEntrada.getHoraInicioFullAsStr(), 
                                              currentMarca.getFechaEntrada() + " " + detalleausenciaEntrada.getHoraFinFullAsStr());
                    String hrsAusenciaTrabajadas = diferencia7.getStrDiferenciaHorasMinutos();
                    
                    ArrayList<String> listaHrsAusencias = new ArrayList<>();
                    ArrayList<DetalleAusenciaVO> detalleausencia = 
                        detalleAusenciaBp.getAusencias(_empleado.getRut(), 
                            currentMarca.getFechaEntrada());
                    
                    //listaHrsAusencias.add(hrsAusenciaTrabajadas);
                    //listaHoras.add(horasMinsTrabajados);
                    //String auxTotHras = Utilidades.sumaHoras(hrsAusenciaTrabajadas, horasMinsTrabajados);
                    //String auxTotHras = Utilidades.sumTimesList(listaHoras);
            
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                        + "Hrs ausencia trabajadas"
                        + ",hrs autorizadas:" + hrsAusenciaTrabajadas
                       // + ",hrs mins trabajados:" + horasMinsTrabajados    
                        + ",hrs trabajadas reales:" + detalleCalculo.getHrsTrabajadas()
                       // + ",hh:mm totales:" + auxTotHras
                        + ",hh:mm atraso existentes:" + detalleCalculo.getHhmmAtraso());
                    if (detalleCalculo.getHhmmAtraso() != null 
                        && hrsAusenciaTrabajadas != null){
                            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.-I-"
                                + "Iterar ausencias para seteo de hrs justificadas...");
                            String auxMsgAusencias = "";
                            String hhmmDifAusencia="";
                            Iterator<DetalleAusenciaVO> ausenciasIterator = detalleausencia.iterator();
                            while (ausenciasIterator.hasNext()) {
                                DetalleAusenciaVO ausencia = ausenciasIterator.next();
                                if (ausencia.getPermiteHora().compareTo("S") == 0){
                                    auxMsgAusencias += ausencia.getNombreAusencia()
                                        +":" + ausencia.getHoraInicioFullAsStr().substring(0, ausencia.getHoraInicioFullAsStr().length()-3) 
                                        +"-" + ausencia.getHoraFinFullAsStr().substring(0, ausencia.getHoraFinFullAsStr().length()-3)+" hrs, ";
                                    //restar hrs con fecha
                                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.Resta hrs inicio-fin ausencia. "
                                        + "Inicio: "+currentMarca.getFechaEntrada() + " " + ausencia.getHoraInicioFullAsStr()
                                        + ", Fin: "+currentMarca.getFechaEntrada() + " " + ausencia.getHoraFinFullAsStr());
                                    DiferenciaHorasVO difAusencia = 
                                            Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + ausencia.getHoraInicioFullAsStr() +":00", 
                                        currentMarca.getFechaEntrada() + " " + ausencia.getHoraFinFullAsStr()+":00");
                                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                                        + "Agregar dif ausencia= " + difAusencia.getStrDiferenciaHorasMinutos());
                                    hhmmDifAusencia = difAusencia.getStrDiferenciaHorasMinutos();
                                    listaHrsAusencias.add(difAusencia.getStrDiferenciaHorasMinutos());
                                }else{
                                    auxMsgAusencias += ausencia.getNombreAusencia()+",";
                                    if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
                                        listaHrsAusencias.add(hhmmTurno);
                                    }
                                    //hrs justificadas = suma de hrs de ausencia...
                                }
                            }
                            String sumaJustificadas = Utilidades.sumTimesList(listaHrsAusencias);
                            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                                + "sumaJustificadas= " + sumaJustificadas
                                + ", hhmmDifAusencia= "+ hhmmDifAusencia);
                            detalleCalculo.setHhmmJustificadas(sumaJustificadas);
                            if (sumaJustificadas.compareTo(hhmmDifAusencia) == 0){
                                detalleCalculo.setHhmmAtraso("");
                            }
                            //detalleCalculo.setHhmmJustificadas(hrsAusenciaTrabajadas);
                            //detalleCalculo.setHhmmAtraso("");
                    }
                    
                    //detalleCalculo.setHrsTrabajadas(auxTotHras);
                    detalleCalculo.setMinutosAtraso(0);
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                        + "NO TIENE MARCAS, "
                        + " Seteo de ausencias...");
                    ArrayList<DetalleAusenciaVO> detalleausencia2 = 
                        detalleAusenciaBp.getAusencias(_empleado.getRut(), 
                            currentMarca.getFechaEntrada());
                    String auxMsgAusencias = "";
                    //iterando ausencias
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.-II-"
                        + "Iterar ausencias para seteo de hrs justificadas...");
                    Iterator<DetalleAusenciaVO> ausenciasIterator = detalleausencia2.iterator();
                    while (ausenciasIterator.hasNext()) {
                        DetalleAusenciaVO ausencia = ausenciasIterator.next();
                        //***
                        if (ausencia.getPermiteHora().compareTo("S") == 0){
                            auxMsgAusencias += ausencia.getNombreAusencia()
                                +":" + ausencia.getHoraInicioFullAsStr().substring(0, ausencia.getHoraInicioFullAsStr().length()-3) 
                                +"-" + ausencia.getHoraFinFullAsStr().substring(0, ausencia.getHoraFinFullAsStr().length()-3)+" hrs, ";
                            //restar hrs con fecha
                            DiferenciaHorasVO difAusencia = Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + ausencia.getHoraInicioFullAsStr() +":00", 
                                currentMarca.getFechaEntrada() + " " + ausencia.getHoraFinFullAsStr()+":00");
                            listaHrsAusencias.add(difAusencia.getStrDiferenciaHorasMinutos());
                        }else{
                            auxMsgAusencias += ausencia.getNombreAusencia();
                            if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
                                listaHrsAusencias.add(hhmmTurno);
                            }
                        }
                    }
                    
                    auxMsgAusencias=auxMsgAusencias.substring(0, auxMsgAusencias.length()-2);
                    detalleCalculo.setObservacion(auxMsgAusencias);
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]setobservacion [99]:"
                        + "auxMsgAusencias: "+auxMsgAusencias);
                    
                }
            }
            if (currentMarca.getFechaEntrada().compareTo(currentMarca.getFechaSalida()) !=0 ){
                DetalleAusenciaVO detalleausenciaSalida = 
                    detalleAusenciaBp.getAusencia(_empleado.getRut(), currentMarca.getFechaSalida());
            
                if (detalleausenciaSalida != null){
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                        + "Tiene ausencias en fecha de salida!");
                    System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                        + "ausenciaHraInicio:" + detalleausenciaSalida.getHoraInicioFullAsStr()
                        + ",ausenciaHraFin:" + detalleausenciaSalida.getHoraFinFullAsStr()
                        + ",ausenciaTipo:" + detalleausenciaSalida.getNombreAusencia()
                        + ",ausenciaPorHora?:" + detalleausenciaSalida.getPermiteHora());
                    detalleCalculo.setHoraInicioAusencia(detalleausenciaSalida.getHoraInicioFullAsStr());
                    detalleCalculo.setHoraFinAusencia(detalleausenciaSalida.getHoraFinFullAsStr());
                    if (detalleausenciaSalida.getPermiteHora().compareTo("S") == 0){
                        System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.-6- fechaHra1: "+currentMarca.getFechaSalida() + " " + detalleausenciaSalida.getHoraInicioFullAsStr()+
                                "fechaHra2: "+currentMarca.getFechaSalida()+" " +detalleausenciaSalida.getHoraFinFullAsStr());
                        DiferenciaHorasVO diferencia7 = 
                                Utilidades.restaHoras(currentMarca.getFechaSalida() + " " + detalleausenciaSalida.getHoraInicioFullAsStr(), 
                                                    currentMarca.getFechaSalida() + " " + detalleausenciaSalida.getHoraFinFullAsStr());
                        String hrsAusenciaTrabajadas = diferencia7.getStrDiferenciaHorasMinutos();
                        //String auxTotHras = Utilidades.sumaHoras(hrsAusenciaTrabajadas, horasMinsTrabajados);
                        ArrayList<String> listaHoras = new ArrayList<>();
                        listaHoras.add(hrsAusenciaTrabajadas);
                        //listaHoras.add(horasMinsTrabajados);
                        //String auxTotHras = Utilidades.sumaHoras(hrsAusenciaTrabajadas, horasMinsTrabajados);
                        String auxTotHras = Utilidades.sumTimesList(listaHoras);

                        System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                            + "Hrs ausencia trabajadas"
                            + "hrs autorizadas:" + hrsAusenciaTrabajadas
                            + ",hrs trabajadas reales:" + detalleCalculo.getHrsTrabajadas()
                            + ",hh:mm totales:" + auxTotHras);
                        if (detalleCalculo.getHhmmAtraso() != null 
                            && hrsAusenciaTrabajadas != null){
                                System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                                + "Seteo de hrs justificadas. "
                                + "El atraso queda en cero por ausencia justificada");
                                ArrayList<DetalleAusenciaVO> detalleausencia = 
                                       detalleAusenciaBp.getAusencias(_empleado.getRut(), 
                                           currentMarca.getFechaEntrada());
                                ArrayList<String> listaHrsAusencias = new ArrayList<>();
                                String auxMsgAusencias="";
                                Iterator<DetalleAusenciaVO> ausenciasIterator = detalleausencia.iterator();
                                while (ausenciasIterator.hasNext()) {
                                    DetalleAusenciaVO ausencia = ausenciasIterator.next();
                                    if (ausencia.getPermiteHora().compareTo("S") == 0){
                                        auxMsgAusencias += ausencia.getNombreAusencia()
                                            +":" + ausencia.getHoraInicioFullAsStr().substring(0, ausencia.getHoraInicioFullAsStr().length()-3) 
                                            +"-" + ausencia.getHoraFinFullAsStr().substring(0, ausencia.getHoraFinFullAsStr().length()-3)+" hrs, ";
                                        //restar hrs con fecha
                                        DiferenciaHorasVO difAusencia = Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + ausencia.getHoraInicioFullAsStr() +":00", 
                                               currentMarca.getFechaEntrada() + " " + ausencia.getHoraFinFullAsStr()+":00");
                                        listaHrsAusencias.add(difAusencia.getStrDiferenciaHorasMinutos());
                                    }else{
                                        auxMsgAusencias += ausencia.getNombreAusencia()+",";
                                        if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
                                            listaHrsAusencias.add(hhmmTurno);
                                        }
                                        //hrs justificadas = suma de hrs de ausencia...
                                    }
                                }
                                String sumaJustificadas = Utilidades.sumTimesList(listaHrsAusencias);
                                detalleCalculo.setHhmmJustificadas(sumaJustificadas);
                                //detalleCalculo.setHhmmJustificadas(hrsAusenciaTrabajadas);
                                detalleCalculo.setHhmmAtraso("");
                        }
                        //detalleCalculo.setHrsTrabajadas(auxTotHras);
                        detalleCalculo.setMinutosAtraso(0);
                        System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                            + "NO TIENE MARCAS, "
                            + "Set observacion[4]. Con detalle de ausencias");

                        ArrayList<DetalleAusenciaVO> detalleausencia = 
                            detalleAusenciaBp.getAusencias(_empleado.getRut(), 
                                currentMarca.getFechaSalida());
                        String auxMsgAusencias = "";
                        //iterando ausencias
                        Iterator<DetalleAusenciaVO> ausenciasIterator = detalleausencia.iterator();
                        while (ausenciasIterator.hasNext()) {
                            DetalleAusenciaVO ausencia = ausenciasIterator.next();
                            //**
                            auxMsgAusencias += ausencia.getNombreAusencia();
                            if (ausencia.getPermiteHora().compareTo("S") == 0){
                                auxMsgAusencias += ausencia.getNombreAusencia()
                                    +":" + ausencia.getHoraInicioFullAsStr().substring(0, ausencia.getHoraInicioFullAsStr().length()-3) 
                                    +"-" + ausencia.getHoraFinFullAsStr().substring(0, ausencia.getHoraFinFullAsStr().length()-3)+" hrs, ";
                                //restar hrs con fecha
                                DiferenciaHorasVO difAusencia = Utilidades.restaHoras(currentMarca.getFechaEntrada() + " " + ausencia.getHoraInicioFullAsStr() +":00", 
                                       currentMarca.getFechaEntrada() + " " + ausencia.getHoraFinFullAsStr()+":00");
                                //listaHrsAusencias.add(difAusencia.getStrDiferenciaHorasMinutos());
                            }else{
                                auxMsgAusencias += ausencia.getNombreAusencia();
    //                            if (hhmmTurno != null && hhmmTurno.compareTo("") != 0){
    //                                listaHrsAusencias.add(hhmmTurno);
    //                            }
                                //hrs justificadas = suma de hrs de ausencia...
                            }

    //                        auxMsgAusencias += ausencia.getNombreAusencia()
    //                            +":"+ausencia.getHoraInicioFullAsStr().substring(0, ausencia.getHoraInicioFullAsStr().length()-3) 
    //                            +"-"+ausencia.getHoraFinFullAsStr().substring(0, ausencia.getHoraFinFullAsStr().length()-3)+" hrs, ";
                            //***
                        }
                        auxMsgAusencias=auxMsgAusencias.substring(0, auxMsgAusencias.length()-2);
                        detalleCalculo.setObservacion(auxMsgAusencias);
    //                    detalleCalculo.setObservacion(detalleausenciaSalida.getNombreAusencia()
    //                        +" de "+detalleausenciaSalida.getHoraInicioFullAsStr().substring(0, detalleausenciaSalida.getHoraInicioFullAsStr().length()-3) 
    //                        +" a "+detalleausenciaSalida.getHoraFinFullAsStr().substring(0, detalleausenciaSalida.getHoraFinFullAsStr().length()-3)+" hrs");
                    }
                }
            }
            System.err.println("[GestionFemase."
                + "CalculoAsistenciaBp]"
                + "getInfoAsistencia."
                + "observacion a setear: "+detalleCalculo.getObservacion());
            
////            if (_detalleTurnoRotLibre!=null){
////                System.err.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia.Set observacion= dia libre");
////                detalleCalculo.setObservacion("Dia libre");
////            }
            /**
             * Tipos de hrs extras:
                A.- Dentro del turno (dia habil)       	al 50 o al 100%?
                B.- Dentro del turno (dia feriado)     	al 50 o al 100%?
                C.- Fuera del turno (dia habil) 	al 50 o al 100%?
                D.- Fuera del turno (dia feriado)   al 50 o al 100%?
             */
            int factorHE = 50;
            if (!_empleado.isArticulo22()){
                if (minutosExtras > 0){
                    if (_horasTeoricas == 0){
                        /** 
                         *  FUERA DE TURNO
                         */
                        if (detalleCalculo.isEsFeriado()){
                            factorHE = _hashTiposHE.get("D");
                        }else factorHE = _hashTiposHE.get("C");

                        System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                            + "codDia esta fuera de turno");
                        //minsExtrasAl100=minutosTrabajados;
                        if (factorHE == 50){
                            detalleCalculo.setMinutosExtrasAl50(minutosExtras);
                        }else if (factorHE == 100){
                            detalleCalculo.setMinutosExtrasAl100(minutosExtras);
                        }

                    }else if (_horasTeoricas > 0){
                            /** 
                            *  DENTRO DE TURNO
                            */
                           if (detalleCalculo.isEsFeriado()){
                               factorHE = _hashTiposHE.get("B");
                           }else factorHE = _hashTiposHE.get("A");

                            System.out.println("[GestionFemase."
                                    + "CalculoAsistenciaBp]getInfoAsistencia."
                                + "codDia esta fuera de turno");
                            //minsExtrasAl100=minutosTrabajados;
                            if (factorHE == 50){
                                detalleCalculo.setMinutosExtrasAl50(minutosExtras);
                            }else if (factorHE == 100){
                                detalleCalculo.setMinutosExtrasAl100(minutosExtras);
                            }
                    }     
                }
            }

            detalleCalculo.setMinutosTeoricos(_horasTeoricas * 60);
//            String auxKey=detalleCalculo.getFechaEntradaMarca()
//                +"|"+currentMarca.getHoraEntrada()
//                +"|"+_empleado.getRut();
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getInfoAsistencia."
                + "**3** Set detalleCalculo."
                + ",fecha entrada=" + detalleCalculo.getFechaEntradaMarca()
                +", hora Entrada=" + detalleCalculo.getHoraEntrada()
                +", observacion=" + detalleCalculo.getObservacion());
            
            auxDetalleCalculoReturn = detalleCalculo;
//            auxLstDetalleCalculoReturn.put(auxKey, detalleCalculo);
            
        }//fin while 8
        
        
        return auxDetalleCalculoReturn;
    }
    
    private String getHorasMinutosAtraso(String _horaMarcaEntrada, String _horaTurnoEntrada){
        String hhmmAtraso = "";//int auxMinsAtraso = diferenciaEntradaTurno.getIntDiferenciaMinutos(); 
        String h1 = _horaMarcaEntrada;//marca 
        String h2 = _horaTurnoEntrada;//turno
        int aux2 = Utilidades.comparaHoras(h2,h1);
        DiferenciaHorasVO diferenciaHoraEntrada = Utilidades.restaHoras(h1, h2);
        System.out.println("[GestionFemase.CalculoAsistenciaBp]getHorasMinutosAtraso."
            + "hora1: "+h1+", hora2: "+h2+", diferencia: " + aux2);
        if (aux2 == 1){
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getHorasMinutosAtraso."
                + "Hora marca entrada: " + h1 
                + ", hora turno entrada: " + h2 
                + ", Setear atraso de hh:mm= " + diferenciaHoraEntrada.getStrDiferenciaHorasMinutos());
            hhmmAtraso = diferenciaHoraEntrada.getStrDiferenciaHorasMinutos();
        }else{
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getHorasMinutosAtraso."
                + "Hora marca entrada: " + h1 
                + ", hora turno entrada: " + h2 
                + ", No Hay atraso");
        }
        return hhmmAtraso;
    }
    
    /**
     * 
     * Procesa marcas de empleado con turno rotativo
     * 
     */
    private MarcaVO getMarcaTurnoRotativo(MarcasBp _marcasBp, 
            EmpleadoVO _empleado, 
            String _fechaMarca, 
            String _horaMarca, 
            int _tipoMarca){
    
        MarcaVO marca=null;
        SimpleDateFormat fechaFmt = new SimpleDateFormat("yyyy-MM-dd");
        String keyMarca = _fechaMarca + "|" + _horaMarca;
        Date dteFechamarca = Utilidades.getDateFromString(_fechaMarca, "yyyy-MM-dd");
        Date dteAnterior = Utilidades.sumaRestarFecha(dteFechamarca, -1, "DAYS");
        Date dteSiguiente = Utilidades.sumaRestarFecha(dteFechamarca, 1, "DAYS");
        String strDiaAnterior = Utilidades.getDatePartAsString(dteAnterior, "yyyy-MM-dd");
        String strDiaSiguiente = Utilidades.getDatePartAsString(dteSiguiente, "yyyy-MM-dd");
        System.out.println("[GestionFemase.CalculoAsistenciaBp]getMarcaTurnoRotativo. "
            + "keyMarca: "+keyMarca
            + ",diaAnterior: "+strDiaAnterior
            + ",diaSiguiente: "+strDiaSiguiente);
        if (_tipoMarca == 1){//es una marca de entrada
            // -------- buscar marca de salida el dia siguiente ------------
            //no siempre se debe buscar la marca al dia sgte...
            DiferenciaHorasVO diferenciaET = 
                    Utilidades.restaHoras(fechaFmt.format(new Date()) + " " + _horaMarca, 
                                          fechaFmt.format(new Date())+" 23:59:59");
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getMarcaTurnoRotativo."
                + "horaEntrada: " 
                + _horaMarca
                +", diferencia en horas con las 23:59:59= " 
                + diferenciaET.getIntDiferenciaHoras());
            if (diferenciaET.getIntDiferenciaHoras() <= 4){
                //fecha salida = dia siguiente (turno noche)
                marca = _marcasBp.getMarcaByTipo(_empleado.getEmpresa().getId(), 
                    _empleado.getRut(), 
                    strDiaSiguiente, strDiaSiguiente,2, _fechaMarca + " " + _horaMarca);
            }else{
                //fecha salida = misma fecha de la entrada (turno normal)
                marca = _marcasBp.getMarcaByTipo(_empleado.getEmpresa().getId(), 
                    _empleado.getRut(), 
                    fechaFmt.format(dteFechamarca), fechaFmt.format(dteFechamarca),2,_fechaMarca + " " + _horaMarca);
            }
            
        }else if (m_marcasProcesadas.get(keyMarca)== null){//si la hora marca no est procesada
                // ------- buscar marca de entrada el dia anterior -------------
                marca = _marcasBp.getMarcaByTipo(_empleado.getEmpresa().getId(), 
                    _empleado.getRut(), 
                    strDiaAnterior, strDiaAnterior,1,null);
        }
        if (marca!=null){
            System.out.println("[GestionFemase.CalculoAsistenciaBp]getMarcaTurnoRotativo."
                + "Agregar marca fecha-hora: "+marca.getFechaHora());
        }
        return marca;
    }
}
